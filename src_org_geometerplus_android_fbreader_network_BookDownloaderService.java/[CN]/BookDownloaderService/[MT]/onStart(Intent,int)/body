{
  super.onStart(intent,startId);
  doStart();
  final Uri uri=intent.getData();
  if (uri == null) {
    doStop();
    return;
  }
  intent.setData(null);
  final int notifications=intent.getIntExtra(SHOW_NOTIFICATIONS_KEY,0);
  final String url=uri.toString();
  final int bookFormat=intent.getIntExtra(BOOK_FORMAT_KEY,BookReference.Format.NONE);
  final int referenceType=intent.getIntExtra(REFERENCE_TYPE_KEY,BookReference.Type.UNKNOWN);
  String cleanURL=intent.getStringExtra(CLEAN_URL_KEY);
  if (cleanURL == null) {
    cleanURL=url;
  }
  String fileName=BookReference.makeBookFileName(cleanURL,bookFormat,referenceType);
  if (fileName == null) {
    doStop();
    return;
  }
  int index=fileName.lastIndexOf(File.separator);
  if (index != -1) {
    final String dir=fileName.substring(0,index);
    final File dirFile=new File(dir);
    if (!dirFile.exists() && !dirFile.mkdirs()) {
      doStop();
      return;
    }
    if (!dirFile.exists() || !dirFile.isDirectory()) {
      doStop();
      return;
    }
  }
  final File fileFile=new File(fileName);
  if (fileFile.exists()) {
    if (!fileFile.isFile()) {
      doStop();
      return;
    }
    doStop();
    startActivity(getFBReaderIntent(fileFile));
    return;
  }
  String title=intent.getStringExtra(TITLE_KEY);
  if (title == null || title.length() == 0) {
    title=fileFile.getName();
  }
  if (title == null || title.length() == 0) {
    title=getResource().getResource("untitled").getValue();
  }
  if ((notifications & Notifications.DOWNLOAD_STARTED) != 0) {
    Toast.makeText(getApplicationContext(),getResource().getResource("downloadingStarted").getValue(),Toast.LENGTH_SHORT).show();
  }
  startFileDownload(url,fileFile,title);
}
