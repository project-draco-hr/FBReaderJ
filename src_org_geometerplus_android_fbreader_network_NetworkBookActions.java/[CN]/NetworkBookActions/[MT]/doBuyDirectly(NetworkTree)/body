{
  final NetworkBookTree bookTree=(NetworkBookTree)tree;
  final NetworkBookItem book=bookTree.Book;
  final NetworkAuthenticationManager mgr=book.Link.authenticationManager();
  if (mgr == null) {
    return;
  }
  if (mgr.isAuthorised(true).Status != ZLBoolean3.B3_TRUE) {
    AuthenticationDialog.Instance().show(book.Link);
    return;
  }
  final ZLResource dialogResource=ZLResource.resource("dialog");
  final ZLResource buttonResource=dialogResource.getResource("button");
  final DialogInterface.OnClickListener listener=new DialogInterface.OnClickListener(){
    public void onClick(    DialogInterface dialog,    int which){
      if (which == DialogInterface.BUTTON_NEGATIVE) {
        return;
      }
      final boolean downloadBook=which == DialogInterface.BUTTON_NEUTRAL;
      if (mgr.needPurchase(book)) {
        final Handler handler=new Handler(){
          public void handleMessage(          Message message){
            String err=(String)message.obj;
            if (err != null) {
              final ZLResource boxResource=dialogResource.getResource("networkError");
              new AlertDialog.Builder(NetworkLibraryActivity.Instance).setTitle(boxResource.getResource("title").getValue()).setMessage(err).setIcon(0).setPositiveButton(buttonResource.getResource("ok").getValue(),null).create().show();
            }
 else             if (downloadBook) {
              doDownloadBook(bookTree,false);
            }
            if (mgr.isAuthorised(true).Status == ZLBoolean3.B3_FALSE) {
              final NetworkLibrary library=NetworkLibrary.Instance();
              library.invalidateAccountDependents();
              library.synchronize();
            }
            if (NetworkLibraryActivity.Instance != null) {
              NetworkLibraryActivity.Instance.getAdapter().resetTree();
              NetworkLibraryActivity.Instance.getListView().invalidateViews();
            }
          }
        }
;
        final Runnable runnable=new Runnable(){
          public void run(){
            String err=mgr.purchaseBook(book);
            handler.sendMessage(handler.obtainMessage(0,err));
          }
        }
;
        ((ZLAndroidDialogManager)ZLAndroidDialogManager.Instance()).wait("purchaseBook",runnable,NetworkLibraryActivity.Instance);
      }
    }
  }
;
  final ZLResource boxResource=dialogResource.getResource("purchaseConfirmBox");
  new AlertDialog.Builder(NetworkLibraryActivity.Instance).setTitle(boxResource.getResource("title").getValue()).setMessage(boxResource.getResource("message").getValue().replace("%s",book.Title)).setIcon(0).setPositiveButton(buttonResource.getResource("buy").getValue(),listener).setNeutralButton(buttonResource.getResource("buyAndDownload").getValue(),listener).setNegativeButton(buttonResource.getResource("cancel").getValue(),listener).create().show();
}
