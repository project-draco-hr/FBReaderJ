{
  final NetworkAuthenticationManager mgr=book.Link.authenticationManager();
  if (mgr == null) {
    return;
  }
  final ZLResource dialogResource=ZLResource.resource("dialog");
  final ZLResource buttonResource=dialogResource.getResource("button");
  final DialogInterface.OnClickListener listener=new DialogInterface.OnClickListener(){
    public void onClick(    DialogInterface dialog,    int which){
      if (which == DialogInterface.BUTTON_NEGATIVE) {
        return;
      }
      if (!mgr.needPurchase(book)) {
        return;
      }
      final boolean downloadBook=which == DialogInterface.BUTTON_NEUTRAL;
      final Handler handler=new Handler(){
        public void handleMessage(        Message message){
          String err=(String)message.obj;
          if (err != null) {
            final ZLResource boxResource=dialogResource.getResource("networkError");
            new AlertDialog.Builder(activity).setTitle(boxResource.getResource("title").getValue()).setMessage(err).setIcon(0).setPositiveButton(buttonResource.getResource("ok").getValue(),null).create().show();
          }
 else           if (downloadBook) {
            doDownloadBook(activity,book,false);
          }
          if (mgr.isAuthorised(true).Status == ZLBoolean3.B3_FALSE) {
            final NetworkLibrary library=NetworkLibrary.Instance();
            library.invalidateVisibility();
            library.synchronize();
          }
          if (NetworkView.Instance().isInitialized()) {
            NetworkView.Instance().fireModelChangedAsync();
          }
        }
      }
;
      final Runnable runnable=new Runnable(){
        public void run(){
          String error=null;
          try {
            mgr.purchaseBook(book);
          }
 catch (          ZLNetworkException e) {
            error=e.getMessage();
          }
          handler.sendMessage(handler.obtainMessage(0,error));
        }
      }
;
      AndroidUtil.wait("purchaseBook",runnable,activity);
    }
  }
;
  final Runnable buyRunnable=new Runnable(){
    public void run(){
      if (!mgr.needPurchase(book)) {
        final ZLResource boxResource=dialogResource.getResource("alreadyPurchasedBox");
        new AlertDialog.Builder(activity).setTitle(boxResource.getResource("title").getValue()).setMessage(boxResource.getResource("message").getValue()).setIcon(0).setPositiveButton(buttonResource.getResource("ok").getValue(),null).create().show();
        return;
      }
      final ZLResource boxResource=dialogResource.getResource("purchaseConfirmBox");
      new AlertDialog.Builder(activity).setTitle(boxResource.getResource("title").getValue()).setMessage(boxResource.getResource("message").getValue().replace("%s",book.Title)).setIcon(0).setPositiveButton(buttonResource.getResource("buy").getValue(),listener).setNeutralButton(buttonResource.getResource("buyAndDownload").getValue(),listener).setNegativeButton(buttonResource.getResource("cancel").getValue(),listener).create().show();
    }
  }
;
  if (mgr.isAuthorised(true).Status != ZLBoolean3.B3_TRUE) {
    NetworkDialog.show(activity,NetworkDialog.DIALOG_AUTHENTICATION,book.Link,buyRunnable);
    return;
  }
 else {
    buyRunnable.run();
  }
}
