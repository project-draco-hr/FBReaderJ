{
  final NetworkBookTree bookTree=(NetworkBookTree)tree;
  final NetworkBookItem book=bookTree.Book;
  if (useFullReferences(book)) {
    BookReference reference=book.reference(BookReference.Type.DOWNLOAD_FULL);
    if (reference == null || !NetworkLibraryActivity.Instance.isBeingDownloaded(reference.URL)) {
      if (book.localCopyFileName() != null) {
        return READ_BOOK_ITEM_ID;
      }
 else       if (reference != null) {
        return DOWNLOAD_BOOK_ITEM_ID;
      }
    }
  }
  if (useDemoReferences(book)) {
    BookReference reference=book.reference(BookReference.Type.DOWNLOAD_DEMO);
    if (!NetworkLibraryActivity.Instance.isBeingDownloaded(reference.URL)) {
      if (reference.localCopyFileName(BookReference.Type.DOWNLOAD_DEMO) != null) {
        return READ_DEMO_ITEM_ID;
      }
 else {
        return DOWNLOAD_DEMO_ITEM_ID;
      }
    }
  }
  if (useBuyReferences(book)) {
    if (book.reference(BookReference.Type.BUY) != null) {
      return BUY_DIRECTLY_ITEM_ID;
    }
 else     if (book.reference(BookReference.Type.BUY_IN_BROWSER) != null) {
      return BUY_IN_BROWSER_ITEM_ID;
    }
  }
  return -1;
}
