{
  boolean success=false;
  DefaultHttpClient httpClient=null;
  HttpEntity entity=null;
  try {
    request.doBefore();
    final HttpParams params=new BasicHttpParams();
    HttpConnectionParams.setSoTimeout(params,30000);
    HttpConnectionParams.setConnectionTimeout(params,15000);
    httpClient=new DefaultHttpClient(params);
    final HttpRequestBase httpRequest;
    if (request.PostData != null) {
      httpRequest=new HttpPost(request.URL);
      ((HttpPost)httpRequest).setEntity(new StringEntity(request.PostData,"utf-8"));
    }
 else     if (!request.PostParameters.isEmpty()) {
      httpRequest=new HttpPost(request.URL);
      final List<BasicNameValuePair> list=new ArrayList<BasicNameValuePair>(request.PostParameters.size());
      for (      Map.Entry<String,String> entry : request.PostParameters.entrySet()) {
        list.add(new BasicNameValuePair(entry.getKey(),entry.getValue()));
      }
      ((HttpPost)httpRequest).setEntity(new UrlEncodedFormEntity(list,"utf-8"));
    }
 else {
      httpRequest=new HttpGet(request.URL);
    }
    httpRequest.setHeader("User-Agent",ZLNetworkUtil.getUserAgent());
    httpRequest.setHeader("Accept-Encoding","gzip");
    httpRequest.setHeader("Accept-Language",Locale.getDefault().getLanguage());
    httpClient.setCredentialsProvider(new MyCredentialsProvider(httpRequest));
    HttpResponse response=null;
    for (int retryCounter=0; retryCounter < 3 && entity == null; ++retryCounter) {
      response=httpClient.execute(httpRequest,myHttpContext);
      entity=response.getEntity();
    }
    final int responseCode=response.getStatusLine().getStatusCode();
    InputStream stream=null;
    if (entity != null && responseCode == HttpURLConnection.HTTP_OK) {
      stream=entity.getContent();
    }
    if (stream != null) {
      try {
        final Header encoding=entity.getContentEncoding();
        if (encoding != null && "gzip".equalsIgnoreCase(encoding.getValue())) {
          stream=new GZIPInputStream(stream);
        }
        request.handleStream(stream,(int)entity.getContentLength());
      }
  finally {
        stream.close();
      }
      success=true;
    }
 else {
      if (responseCode == HttpURLConnection.HTTP_UNAUTHORIZED) {
        throw new ZLNetworkException(ZLNetworkException.ERROR_AUTHENTICATION_FAILED);
      }
 else {
        throw new ZLNetworkException(true,response.getStatusLine().toString());
      }
    }
  }
 catch (  ZLNetworkException e) {
    throw e;
  }
catch (  Exception e) {
    e.printStackTrace();
    final String[] eName=e.getClass().getName().split("\\.");
    if (eName.length > 0) {
      throw new ZLNetworkException(true,eName[eName.length - 1] + ": " + e.getMessage(),e);
    }
 else {
      throw new ZLNetworkException(true,e.getMessage(),e);
    }
  }
 finally {
    request.doAfter(success);
    if (httpClient != null) {
      httpClient.getConnectionManager().shutdown();
    }
    if (entity != null) {
      try {
        entity.consumeContent();
      }
 catch (      IOException e) {
      }
    }
  }
}
