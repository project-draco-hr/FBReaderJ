{
  final HashMap<Tag,TagTree> tagTreeMap=new HashMap<Tag,TagTree>();
  final HashMap<Author,AuthorTree> authorTreeMap=new HashMap<Author,AuthorTree>();
  final HashMap<AuthorSeriesPair,SeriesTree> seriesTreeMap=new HashMap<AuthorSeriesPair,SeriesTree>();
  final HashMap<Long,Book> bookById=new HashMap<Long,Book>();
  collectBooks();
  for (  Book book : myBooks) {
    bookById.put(book.getId(),book);
    List<Author> authors=book.authors();
    if (authors.isEmpty()) {
      authors=(List<Author>)myNullList;
    }
    final SeriesInfo seriesInfo=book.getSeriesInfo();
    for (    Author a : authors) {
      AuthorTree authorTree=authorTreeMap.get(a);
      if (authorTree == null) {
        authorTree=myLibraryByAuthor.createAuthorSubTree(a);
        authorTreeMap.put(a,authorTree);
      }
      if (seriesInfo == null) {
        authorTree.createBookSubTree(book,false);
      }
 else {
        final String series=seriesInfo.Name;
        final AuthorSeriesPair pair=new AuthorSeriesPair(a,series);
        SeriesTree seriesTree=seriesTreeMap.get(pair);
        if (seriesTree == null) {
          seriesTree=authorTree.createSeriesSubTree(series);
          seriesTreeMap.put(pair,seriesTree);
        }
        seriesTree.createBookInSeriesSubTree(book);
      }
    }
    List<Tag> tags=book.tags();
    if (tags.isEmpty()) {
      tags=(List<Tag>)myNullList;
    }
    for (    Tag t : tags) {
      getTagTree(t,tagTreeMap).createBookSubTree(book,true);
    }
  }
  boolean doGroupTitlesByFirstLetter=false;
  if (myBooks.size() > 10) {
    final HashSet<Character> letterSet=new HashSet<Character>();
    for (    Book book : myBooks) {
      String title=book.getTitle();
      if (title != null) {
        title=title.trim();
        if (!"".equals(title)) {
          letterSet.add(title.charAt(0));
        }
      }
    }
    doGroupTitlesByFirstLetter=letterSet.size() > myBooks.size() + 4;
  }
  if (doGroupTitlesByFirstLetter) {
    final HashMap<Character,TitleTree> letterTrees=new HashMap<Character,TitleTree>();
    for (    Book book : myBooks) {
      String title=book.getTitle();
      if (title == null) {
        continue;
      }
      title=title.trim();
      if ("".equals(title)) {
        continue;
      }
      Character c=title.charAt(0);
      TitleTree tree=letterTrees.get(c);
      if (tree == null) {
        tree=myLibraryByTitle.createTitleSubTree(c.toString());
        letterTrees.put(c,tree);
      }
      tree.createBookSubTree(book,true);
    }
  }
 else {
    for (    Book book : myBooks) {
      myLibraryByTitle.createBookSubTree(book,true);
    }
  }
  final BooksDatabase db=BooksDatabase.Instance();
  for (  long id : db.loadRecentBookIds()) {
    Book book=bookById.get(id);
    if (book != null) {
      myRecentBooks.createBookSubTree(book,true);
    }
  }
  for (  long id : db.loadFavoritesIds()) {
    Book book=bookById.get(id);
    if (book != null) {
      myFavorites.createBookSubTree(book,true);
    }
  }
  myFavorites.sortAllChildren();
  myLibraryByAuthor.sortAllChildren();
  myLibraryByTitle.sortAllChildren();
  myLibraryByTag.sortAllChildren();
  db.executeAsATransaction(new Runnable(){
    public void run(){
      for (      Book book : myBooks) {
        book.save();
      }
    }
  }
);
  myState=STATE_FULLY_INITIALIZED;
}
