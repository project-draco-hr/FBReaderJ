{
  final FileInfoSet fileInfos=new FileInfoSet();
  final Map<Long,Book> savedBooksByFileId=myDatabase.loadBooks(fileInfos,true);
  final Map<Long,Book> savedBooksByBookId=new HashMap<Long,Book>();
  for (  Book b : savedBooksByFileId.values()) {
    savedBooksByBookId.put(b.getId(),b);
  }
  if (savedBooksByFileId.size() > 10) {
    final HashSet<String> letterSet=new HashSet<String>();
    for (    Book book : savedBooksByFileId.values()) {
      final String letter=TitleTree.firstTitleLetter(book);
      if (letter != null) {
        letterSet.add(letter);
      }
    }
    myDoGroupTitlesByFirstLetter=savedBooksByFileId.values().size() > letterSet.size() * 5 / 4;
  }
  for (  long id : myDatabase.loadRecentBookIds()) {
    Book book=savedBooksByBookId.get(id);
    if (book == null) {
      book=Book.getById(id);
      if (book != null && !book.File.exists()) {
        book=null;
      }
    }
    if (book != null) {
      new BookTree(getFirstLevelTree(ROOT_RECENT),book,true);
    }
  }
  for (  long id : myDatabase.loadFavoritesIds()) {
    Book book=savedBooksByBookId.get(id);
    if (book == null) {
      book=Book.getById(id);
      if (book != null && !book.File.exists()) {
        book=null;
      }
    }
    if (book != null) {
      getFirstLevelTree(ROOT_FAVORITES).getBookSubTree(book,true);
    }
  }
  fireModelChangedEvent(ChangeListener.Code.BookAdded);
  final Set<Book> orphanedBooks=new HashSet<Book>();
  final Set<ZLPhysicalFile> physicalFiles=new HashSet<ZLPhysicalFile>();
  int count=0;
  for (  Book book : savedBooksByFileId.values()) {
synchronized (this) {
      final ZLPhysicalFile file=book.File.getPhysicalFile();
      if (file != null) {
        physicalFiles.add(file);
      }
      if (file != book.File && file != null && file.getPath().endsWith(".epub")) {
        myDatabase.deleteFromBookList(book.getId());
        continue;
      }
      if (book.File.exists()) {
        boolean doAdd=true;
        if (file == null) {
          continue;
        }
        if (!fileInfos.check(file,true)) {
          try {
            book.readMetaInfo();
            book.save();
          }
 catch (          BookReadingException e) {
            doAdd=false;
          }
          file.setCached(false);
        }
        if (doAdd) {
          addBookToLibrary(book);
          if (++count % 16 == 0) {
            fireModelChangedEvent(ChangeListener.Code.BookAdded);
          }
        }
      }
 else {
        myRootTree.removeBook(book,true);
        fireModelChangedEvent(ChangeListener.Code.BookRemoved);
        orphanedBooks.add(book);
      }
    }
  }
  fireModelChangedEvent(ChangeListener.Code.BookAdded);
  myDatabase.setExistingFlag(orphanedBooks,false);
  final Map<Long,Book> orphanedBooksByFileId=myDatabase.loadBooks(fileInfos,false);
  final Set<Book> newBooks=new HashSet<Book>();
  final List<ZLPhysicalFile> physicalFilesList=collectPhysicalFiles();
  for (  ZLPhysicalFile file : physicalFilesList) {
    if (physicalFiles.contains(file)) {
      continue;
    }
    collectBooks(file,fileInfos,savedBooksByFileId,orphanedBooksByFileId,newBooks,!fileInfos.check(file,true));
    file.setCached(false);
  }
  try {
    final ZLFile helpFile=getHelpFile();
    Book helpBook=savedBooksByFileId.get(fileInfos.getId(helpFile));
    if (helpBook == null) {
      helpBook=new Book(helpFile);
    }
    addBookToLibrary(helpBook);
    fireModelChangedEvent(ChangeListener.Code.BookAdded);
  }
 catch (  BookReadingException e) {
    e.printStackTrace();
  }
  fileInfos.save();
  myDatabase.executeAsATransaction(new Runnable(){
    public void run(){
      for (      Book book : newBooks) {
        book.save();
      }
    }
  }
);
  myDatabase.setExistingFlag(newBooks,true);
}
