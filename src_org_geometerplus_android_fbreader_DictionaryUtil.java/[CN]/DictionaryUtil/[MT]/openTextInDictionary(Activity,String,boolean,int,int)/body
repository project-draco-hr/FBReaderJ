{
  Log.d("FBReader","DictionaryUtil:openTextInDictionary");
  if (singleWord) {
    int start=0;
    int end=text.length();
    for (; start < end && !Character.isLetterOrDigit(text.charAt(start)); ++start)     ;
    for (; start < end && !Character.isLetterOrDigit(text.charAt(end - 1)); --end)     ;
    if (start == end) {
      return;
    }
    text=text.substring(start,end);
  }
  final DisplayMetrics metrics=new DisplayMetrics();
  activity.getWindowManager().getDefaultDisplay().getMetrics(metrics);
  final PopupFrameMetric frameMetrics=new PopupFrameMetric(metrics,selectionTop,selectionBottom);
  final PackageInfo info=getCurrentDictionaryInfo(singleWord);
  if (info instanceof OpenDictionaryPackageInfo) {
    Log.d("FBReader","DictionaryUtil - work with Open Dictionary API :" + text);
    final OpenDictionaryPackageInfo openDictionary=(OpenDictionaryPackageInfo)info;
    openDictionary.myFlyout.showTranslation(activity,text,frameMetrics);
    return;
  }
  if ("ABBYY Lingvo".equals(info.Id)) {
    final Intent intent=new Intent(MinicardContract.MINICARD_ACTION);
    intent.putExtra(MinicardContract.EXTRA_TEXT,text);
    intent.putExtra(MinicardContract.EXTRA_GRAVITY,frameMetrics.gravity);
    intent.putExtra(MinicardContract.EXTRA_HEIGHT,frameMetrics.height);
    intent.putExtra(MinicardContract.EXTRA_FORCE_LEMMATIZATION,true);
    intent.putExtra(MinicardContract.EXTRA_TRANSLATE_VARIANTS,true);
    intent.putExtra(MinicardContract.EXTRA_LIGHT_THEME,true);
    if (ourPreferredLanguageOption.getValue() == null || ourPreferredLanguageOption.getValue().equals("")) {
    }
 else {
      intent.putExtra(MinicardContract.EXTRA_LANGUAGE_TO,ourPreferredLanguageOption.getValue());
    }
    try {
      activity.startActivity(intent);
    }
 catch (    ActivityNotFoundException e) {
      DictionaryUtil.installDictionaryIfNotInstalled(activity,singleWord,true);
    }
    return;
  }
  final Intent intent=getDictionaryIntent(info,text);
  try {
    if ("ColorDict".equals(info.Id)) {
      intent.putExtra(ColorDict3.HEIGHT,frameMetrics.height);
      intent.putExtra(ColorDict3.GRAVITY,frameMetrics.gravity);
      final ZLAndroidLibrary zlibrary=(ZLAndroidLibrary)ZLAndroidLibrary.Instance();
      intent.putExtra(ColorDict3.FULLSCREEN,!zlibrary.ShowStatusBarOption.getValue());
    }
    activity.startActivity(intent);
  }
 catch (  ActivityNotFoundException e) {
    DictionaryUtil.installDictionaryIfNotInstalled(activity,singleWord,false);
  }
}
