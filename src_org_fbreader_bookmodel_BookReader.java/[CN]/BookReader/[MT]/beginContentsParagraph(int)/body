{
  final ArrayList<ZLTextTreeParagraph> tocStack=myTOCStack;
  if (myCurrentTextModel == myBookModel.getBookTextModel()) {
    ContentsModel contentsModel=myBookModel.getContentsModel();
    if (referenceNumber == -1) {
      referenceNumber=myCurrentTextModel.getParagraphsNumber();
    }
    int size=tocStack.size();
    ZLTextTreeParagraph peek=(size == 0) ? null : tocStack.get(size - 1);
    if (!myContentsBuffer.isEmpty()) {
      contentsModel.addText(myContentsBuffer);
      myContentsBuffer.clear();
      myLastTOCParagraphIsEmpty=false;
    }
    if (myLastTOCParagraphIsEmpty) {
      contentsModel.addText(PERIOD);
    }
    ZLTextTreeParagraph para=contentsModel.createParagraph(peek);
    contentsModel.addControl(FBTextKind.CONTENTS_TABLE_ENTRY,true);
    contentsModel.setReference(para,referenceNumber);
    tocStack.add(para);
    myLastTOCParagraphIsEmpty=true;
    myContentsParagraphExists=true;
  }
}
