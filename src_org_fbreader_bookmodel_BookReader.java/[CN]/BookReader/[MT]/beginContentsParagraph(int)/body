{
  final ArrayList<ZLTextTreeParagraph> tocStack=myTOCStack;
  if (myCurrentTextModel == myBookModel.getBookModel()) {
    ContentsModel contentsModel=myBookModel.getContentsModel();
    if (referenceNumber == -1) {
      referenceNumber=myCurrentTextModel.getParagraphsNumber();
    }
    int size=tocStack.size();
    ZLTextTreeParagraph peek=(size == 0) ? null : tocStack.get(size - 1);
    if (myContentsBuffer.length() != 0) {
      contentsModel.addText(myContentsBuffer);
      myContentsBuffer.delete(0,myContentsBuffer.length());
      myLastTOCParagraphIsEmpty=false;
    }
    if (myLastTOCParagraphIsEmpty) {
      contentsModel.addText("...");
    }
    ZLTextTreeParagraph para=contentsModel.createParagraph(peek);
    contentsModel.addControl(FBTextKind.CONTENTS_TABLE_ENTRY,true);
    contentsModel.setReference(para,referenceNumber);
    tocStack.add(para);
    myLastTOCParagraphIsEmpty=true;
    myContentsParagraphExists=true;
  }
}
