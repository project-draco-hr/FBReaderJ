{
  final ZLTextPlainModelImpl textModel=myCurrentTextModel;
  final ArrayList<ZLTextTreeParagraph> tocStack=myTOCStack;
  if (textModel == myBookModel.getBookTextModel()) {
    ContentsModel contentsModel=myBookModel.getContentsModel();
    if (referenceNumber == -1) {
      referenceNumber=textModel.getParagraphsNumber();
    }
    int size=tocStack.size();
    ZLTextTreeParagraph peek=(size == 0) ? null : tocStack.get(size - 1);
    final ZLTextBuffer contentsBuffer=myContentsBuffer;
    if (!contentsBuffer.isEmpty()) {
      contentsModel.addText(contentsBuffer);
      contentsBuffer.clear();
      myLastTOCParagraphIsEmpty=false;
    }
 else     if (myLastTOCParagraphIsEmpty) {
      contentsModel.addText(PERIOD);
    }
    ZLTextTreeParagraph para=contentsModel.createParagraph(peek);
    contentsModel.addControl(FBTextKind.CONTENTS_TABLE_ENTRY,true);
    contentsModel.setReference(para,referenceNumber);
    tocStack.add(para);
    myLastTOCParagraphIsEmpty=true;
    myContentsParagraphExists=true;
  }
}
