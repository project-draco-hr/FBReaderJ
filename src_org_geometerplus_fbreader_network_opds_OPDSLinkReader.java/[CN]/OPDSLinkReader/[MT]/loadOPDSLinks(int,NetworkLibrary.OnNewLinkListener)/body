{
  final File dirFile=new File(Paths.networkCacheDirectory());
  if (!dirFile.exists() && !dirFile.mkdirs()) {
    return NetworkErrors.errorMessage("cacheDirectoryError");
  }
  final String fileName="fbreader_catalogs-" + CATALOGS_URL.substring(CATALOGS_URL.lastIndexOf(File.separator) + 1);
  boolean goodCache=false;
  File oldCache=null;
  ATOMUpdated cacheUpdatedTime=null;
  final File catalogsFile=new File(dirFile,fileName);
  if (catalogsFile.exists()) {
switch (cacheMode) {
case CACHE_UPDATE:
      try {
        final OPDSLinkXMLReader reader=new OPDSLinkXMLReader();
        reader.read(new FileInputStream(catalogsFile));
        cacheUpdatedTime=reader.getUpdatedTime();
      }
 catch (      FileNotFoundException e) {
        throw new RuntimeException("That's impossible!!!",e);
      }
    final long diff=System.currentTimeMillis() - catalogsFile.lastModified();
  final long valid=7 * 24 * 60* 60* 1000;
if (diff >= 0 && diff <= valid) {
  goodCache=true;
  break;
}
case CACHE_CLEAR:
oldCache=new File(dirFile,"_" + fileName);
oldCache.delete();
if (!catalogsFile.renameTo(oldCache)) {
catalogsFile.delete();
oldCache=null;
}
break;
case CACHE_LOAD:
goodCache=true;
break;
default :
throw new IllegalArgumentException("Invalid cacheMode value (" + cacheMode + ") in OPDSLinkReader.loadOPDSLinks method");
}
}
String error=null;
if (!goodCache) {
error=ZLNetworkManager.Instance().downloadToFile(CATALOGS_URL,catalogsFile);
}
if (error != null) {
if (oldCache == null) {
return error;
}
catalogsFile.delete();
if (!oldCache.renameTo(catalogsFile)) {
oldCache.delete();
return error;
}
}
 else if (oldCache != null) {
oldCache.delete();
oldCache=null;
}
try {
new OPDSLinkXMLReader(listener,cacheUpdatedTime).read(new FileInputStream(catalogsFile));
}
 catch (FileNotFoundException e) {
throw new RuntimeException("That's impossible!!!",e);
}
return null;
}
