{
  final List<Book> allBooks;
synchronized (myBooksByFile) {
    allBooks=new ArrayList<Book>(new LinkedHashSet<Book>(myBooksByFile.values()));
  }
  final int start=query.Page * query.Limit;
  if (start >= allBooks.size()) {
    return Collections.emptyList();
  }
  final int end=start + query.Limit;
  if (query.Filter instanceof Filter.Empty) {
    return allBooks.subList(start,Math.min(end,allBooks.size()));
  }
 else {
    int count=0;
    final List<Book> filtered=new ArrayList<Book>(query.Limit);
    for (    Book b : allBooks) {
      if (query.Filter.matches(b)) {
        if (count >= start) {
          filtered.add(b);
        }
        if (++count == end) {
          break;
        }
      }
    }
    return filtered;
  }
}
