{
  final String tag=getCollectionModel().getTagByParagraphIndex(paragraphIndex);
  if (tag == null) {
    return;
  }
  final boolean tagIsSpecial=(tag == SpecialTagAllBooks) || (tag == SpecialTagNoTagsBooks);
  final String tagDisplayName=tagIsSpecial ? "" : tag;
  final boolean editNotClone=tag != SpecialTagAllBooks;
  final boolean includeSubtags=!tagIsSpecial && Collection.hasSubtags(tag);
  final boolean hasBooks=Collection.hasBooks(tag);
  final TreeSet tagSet=new TreeSet();
  final ArrayList books=Collection.books();
  final int len=books.size();
  for (int i=0; i < len; ++i) {
    tagSet.addAll(((BookDescription)books.get(i)).getTags());
  }
  final TreeSet fullTagSet=new TreeSet(tagSet);
  for (Iterator it=tagSet.iterator(); it.hasNext(); ) {
    final String value=(String)it.next();
    for (int index=0; ; ) {
      index=value.indexOf('/',index);
      if (index == -1) {
        break;
      }
      fullTagSet.add(value.substring(0,index++));
    }
  }
  final ArrayList names=new ArrayList();
  if (!fullTagSet.contains(tagDisplayName)) {
    names.add(tagDisplayName);
  }
  names.addAll(fullTagSet);
  new EditTagDialog(names,tag,tagIsSpecial,includeSubtags,hasBooks,editNotClone).run();
}
