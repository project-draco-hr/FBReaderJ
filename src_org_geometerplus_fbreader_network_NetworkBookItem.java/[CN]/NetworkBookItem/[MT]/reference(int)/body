{
  BookReference reference=null;
  for (  BookReference ref : myReferences) {
    if (ref.ReferenceType == type && (reference == null || ref.BookFormat > reference.BookFormat)) {
      reference=ref;
    }
  }
  if (reference == null && type == BookReference.Type.DOWNLOAD_FULL) {
    reference=this.reference(BookReference.Type.DOWNLOAD_FULL_CONDITIONAL);
    if (reference != null) {
      NetworkAuthenticationManager authManager=Link.authenticationManager();
      if (authManager == null || authManager.needPurchase(this)) {
        return null;
      }
      reference=authManager.downloadReference(this);
    }
  }
  if (reference == null && type == BookReference.Type.DOWNLOAD_FULL && this.reference(BookReference.Type.BUY) == null && this.reference(BookReference.Type.BUY_IN_BROWSER) == null) {
    reference=this.reference(BookReference.Type.DOWNLOAD_FULL_OR_DEMO);
  }
  if (reference == null && type == BookReference.Type.DOWNLOAD_DEMO && (this.reference(BookReference.Type.BUY) != null || this.reference(BookReference.Type.BUY_IN_BROWSER) != null)) {
    reference=this.reference(BookReference.Type.DOWNLOAD_FULL_OR_DEMO);
  }
  return reference;
}
