{
  BookReference reference=null;
  for (  BookReference ref : myReferences) {
    if (ref.ReferenceType == type && (reference == null || ref.BookFormat > reference.BookFormat)) {
      reference=ref;
    }
  }
  if (reference == null && type == BookReference.Type.Book) {
    reference=this.reference(BookReference.Type.BookConditional);
    if (reference != null) {
      NetworkAuthenticationManager authManager=Link.authenticationManager();
      if (authManager == null || authManager.needPurchase(this)) {
        return null;
      }
      reference=authManager.downloadReference(this);
    }
  }
  if (reference == null && type == BookReference.Type.Book && this.reference(BookReference.Type.BookBuy) == null && this.reference(BookReference.Type.BookBuyInBrowser) == null) {
    reference=this.reference(BookReference.Type.BookFullOrDemo);
  }
  if (reference == null && type == BookReference.Type.BookDemo && (this.reference(BookReference.Type.BookBuy) != null || this.reference(BookReference.Type.BookBuyInBrowser) != null)) {
    reference=this.reference(BookReference.Type.BookFullOrDemo);
  }
  return reference;
}
