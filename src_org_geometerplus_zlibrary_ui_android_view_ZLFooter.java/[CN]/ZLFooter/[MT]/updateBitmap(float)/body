{
  boolean infoChanged=false;
  final ZLTextView view=(ZLTextView)ZLApplication.Instance().getCurrentView();
  int bgColor=ZLAndroidColorUtil.rgb(view.getBackgroundColor());
  int fgColor=ZLAndroidColorUtil.rgb(view.getTextColor(FBHyperlinkType.NONE));
  if (myLastFgColor != fgColor || myLastBgColor != bgColor) {
    infoChanged=true;
    myLastFgColor=fgColor;
    myLastBgColor=bgColor;
  }
  int height=view.getFooterArea().getHeight();
  int delta=height <= 10 ? 0 : 1;
  if (height != myLastHeight) {
    myLastHeight=height;
    mySize.y=height;
    myTextPaint.setTextSize(height <= 10 ? height + 3 : height + 1);
    myFgPaint.setStrokeWidth(height <= 10 ? 1 : 2);
    myTextPaint.setTypeface(Typeface.create(Typeface.SANS_SERIF,height <= 10 ? Typeface.NORMAL : Typeface.BOLD));
    myTextPaint.setTextAlign(Paint.Align.RIGHT);
    myTextPaint.setStyle(Paint.Style.FILL);
    myTextPaint.setAntiAlias(true);
  }
  if (myBitmap == null || myBitmap.getWidth() != mySize.x || myBitmap.getHeight() != mySize.y) {
    myBitmap=Bitmap.createBitmap(mySize.x,mySize.y,Bitmap.Config.RGB_565);
    infoChanged=true;
  }
  Canvas canvas=new Canvas(myBitmap);
  final ZLTextView textView=(ZLTextView)view;
  final int pagesProgress=textView.computeCurrentPage();
  final int bookLength=textView.computePageNumber();
  final FBReader fbReader=(FBReader)FBReader.Instance();
  final StringBuilder info=new StringBuilder();
  if (fbReader.FooterShowProgress.getValue()) {
    info.append(pagesProgress);
    info.append("/");
    info.append(bookLength);
  }
  if (fbReader.FooterShowBattery.getValue()) {
    if (info.length() > 0) {
      info.append(" ");
    }
    info.append(ZLApplication.Instance().getBatteryLevel());
    info.append("%");
  }
  if (fbReader.FooterShowClock.getValue()) {
    if (info.length() > 0) {
      info.append(" ");
    }
    Date date=new Date();
    info.append(String.format("%02d:%02d",date.getHours(),date.getMinutes()));
  }
  final String infoString=info.toString();
  if (!infoString.equals(myInfoString)) {
    myInfoString=infoString;
    infoChanged=true;
  }
  if (infoChanged) {
    Rect infoRect=new Rect();
    myTextPaint.getTextBounds(infoString,0,infoString.length(),infoRect);
    int infoWidth=infoString.equals("") ? 0 : infoRect.width() + 10;
    myBgPaint.setColor(bgColor);
    canvas.drawRect(mySize.x - infoWidth,0,mySize.x,mySize.y,myBgPaint);
    myTextPaint.setColor(fgColor);
    canvas.drawText(infoString,mySize.x - 1,mySize.y - delta,myTextPaint);
    myBgPaint.setColor(bgColor);
    myGaugeRect.set(0,0,mySize.x - infoWidth,mySize.y);
    canvas.drawRect(myGaugeRect,myBgPaint);
    myFgPaint.setColor(fgColor);
    myFgPaint.setStyle(Paint.Style.STROKE);
    myGaugeRect.right-=(1 - delta);
    myGaugeRect.inset(1 + delta,1 + delta);
    canvas.drawRect(myGaugeRect,myFgPaint);
    myGaugeStart=myGaugeRect.left;
    myGaugeEnd=myGaugeRect.right;
    myGaugeRect.inset(2 + delta,2 + delta);
    myGaugeRect.right=myGaugeRect.left + (int)((float)myGaugeRect.width() * pagesProgress / bookLength);
    canvas.drawRect(myGaugeRect,myFgPaint);
  }
}
