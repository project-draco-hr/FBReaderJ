{
  boolean gaugeChanged=false;
  boolean infoChanged=false;
  final ZLTextView view=(ZLTextView)ZLApplication.Instance().getCurrentView();
  int bgColor=ZLAndroidColorUtil.rgb(view.getBackgroundColor());
  int fgColor=ZLAndroidColorUtil.rgb(view.getFooterColor());
  if (myLastFgColor != fgColor || myLastBgColor != bgColor) {
    gaugeChanged=true;
    infoChanged=true;
  }
  int size=view.getFooterHeight();
  int delta=size <= 10 ? 0 : 1;
  if (size != myLastSize) {
    mySize.y=size;
    myTextPaint.setTextSize(size <= 10 ? size + 3 : size + 1);
    myFgPaint.setStrokeWidth(size <= 10 ? 1 : 2);
    myTextPaint.setTypeface(Typeface.create(Typeface.SANS_SERIF,size <= 10 ? Typeface.NORMAL : Typeface.BOLD));
    myTextPaint.setTextAlign(Paint.Align.RIGHT);
    myTextPaint.setStyle(Paint.Style.FILL);
    myTextPaint.setAntiAlias(true);
  }
  if (myBitmap == null || myBitmap.getWidth() != mySize.x || myBitmap.getHeight() != mySize.y) {
    myBitmap=Bitmap.createBitmap(mySize.x,mySize.y,Bitmap.Config.RGB_565);
    gaugeChanged=true;
    infoChanged=true;
  }
  Canvas canvas=new Canvas(myBitmap);
  final ZLTextView textView=(ZLTextView)view;
  final int pagesProgress=textView.computeCurrentPage();
  final int bookLength=textView.computePageNumber();
  float progress=1.0f * pagesProgress / bookLength;
  if (progress != myLastProgress) {
    gaugeChanged=true;
  }
  FBReader fbReader=(FBReader)FBReader.Instance();
  Date date=new Date();
  if (infoChanged || myLastShowClock != fbReader.FooterShowClock.getValue() || myLastShowBattery != fbReader.FooterShowBattery.getValue() || myLastShowProgress != fbReader.FooterShowProgress.getValue() || (fbReader.FooterShowClock.getValue() && (myLastHours != date.getHours() || myLastMinutes != date.getMinutes())) || (fbReader.FooterShowProgress.getValue() && (myLastPagesNum != bookLength || myLastPage != pagesProgress)) || (fbReader.FooterShowBattery.getValue() && (myLastBattery != ZLApplication.Instance().myBatteryLevel))) {
    infoChanged=true;
  }
  if (infoChanged) {
    String info="";
    if (fbReader.FooterShowClock.getValue()) {
      info+=String.format("%02d:%02d",date.getHours(),date.getMinutes());
    }
    if (fbReader.FooterShowBattery.getValue()) {
      info=String.format("%d%%",ZLApplication.Instance().myBatteryLevel) + (info.equals("") ? "" : " ") + info;
    }
    if (fbReader.FooterShowProgress.getValue()) {
      info=String.format("%d/%d",pagesProgress,bookLength) + (info.equals("") ? "" : " ") + info;
    }
    Rect infoRect=new Rect();
    myTextPaint.getTextBounds(info,0,info.length(),infoRect);
    int infoWidth=(info.equals("") ? 0 : infoRect.width() + 10);
    if (myInfoWidth != infoWidth) {
      gaugeChanged=true;
      myInfoWidth=infoWidth;
    }
    myBgPaint.setColor(bgColor);
    canvas.drawRect(mySize.x - myInfoWidth,0,mySize.x,mySize.y,myBgPaint);
    myTextPaint.setColor(fgColor);
    canvas.drawText(info,mySize.x - 1,mySize.y - delta,myTextPaint);
  }
  if (gaugeChanged) {
    myBgPaint.setColor(bgColor);
    myGaugeRect.set(0,0,mySize.x - myInfoWidth,mySize.y);
    canvas.drawRect(myGaugeRect,myBgPaint);
    myFgPaint.setColor(fgColor);
    myFgPaint.setStyle(Paint.Style.STROKE);
    myGaugeRect.right-=(1 - delta);
    myGaugeRect.inset(1 + delta,1 + delta);
    canvas.drawRect(myGaugeRect,myFgPaint);
    myGaugeStart=myGaugeRect.left;
    myGaugeEnd=myGaugeRect.right;
    myGaugeRect.inset(2 + delta,2 + delta);
    myGaugeRect.right=myGaugeRect.left + (int)((float)myGaugeRect.width() * progress);
    canvas.drawRect(myGaugeRect,myFgPaint);
  }
  myLastProgress=progress;
  myLastBattery=ZLApplication.Instance().myBatteryLevel;
  myLastHours=date.getHours();
  myLastMinutes=date.getMinutes();
  myLastFgColor=fgColor;
  myLastBgColor=bgColor;
  myLastShowClock=fbReader.FooterShowClock.getValue();
  myLastShowBattery=fbReader.FooterShowBattery.getValue();
  myLastShowProgress=fbReader.FooterShowProgress.getValue();
  myLastPagesNum=bookLength;
  myLastPage=pagesProgress;
  myLastSize=size;
}
