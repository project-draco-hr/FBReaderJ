{
  final View layout=activity.getLayoutInflater().inflate(R.layout.network_custom_catalog_dialog,null);
  setupLabel(layout,R.id.network_catalog_title_text,"catalogTitle",R.id.network_catalog_title);
  setupLabel(layout,R.id.network_catalog_url_text,"catalogUrl",R.id.network_catalog_url);
  setupLabel(layout,R.id.network_catalog_summary_text,"catalogSummary",R.id.network_catalog_summary);
  final Handler handler=new Handler(){
    public void handleMessage(    Message message){
      if (!NetworkView.Instance().isInitialized()) {
        return;
      }
      final NetworkLibrary library=NetworkLibrary.Instance();
      library.invalidate();
      library.invalidateVisibility();
      library.synchronize();
      NetworkView.Instance().fireModelChanged();
      if (message.what < 0) {
        if (message.what == -2) {
          final ZLResource dialogResource=ZLResource.resource("dialog");
          final ZLResource boxResource=dialogResource.getResource("networkError");
          final ZLResource buttonResource=dialogResource.getResource("button");
          new AlertDialog.Builder(activity).setTitle(boxResource.getResource("title").getValue()).setMessage((String)message.obj).setIcon(0).setPositiveButton(buttonResource.getResource("ok").getValue(),null).create().show();
        }
 else {
          myErrorMessage=(String)message.obj;
          activity.showDialog(NetworkDialog.DIALOG_CUSTOM_CATALOG);
          return;
        }
      }
 else       if (message.what > 0) {
        if (myOnSuccessRunnable != null) {
          myOnSuccessRunnable.run();
        }
      }
      clearData();
    }
  }
;
  final DialogInterface.OnClickListener listener=new DialogInterface.OnClickListener(){
    public void onClick(    DialogInterface dialog,    int which){
      if (which == DialogInterface.BUTTON_POSITIVE) {
        AlertDialog alert=(AlertDialog)dialog;
        myTitle=((TextView)alert.findViewById(R.id.network_catalog_title)).getText().toString().trim();
        myUrl=((TextView)alert.findViewById(R.id.network_catalog_url)).getText().toString().trim();
        mySummary=((TextView)alert.findViewById(R.id.network_catalog_summary)).getText().toString().trim();
        if (myTitle.length() == 0) {
          myTitle=null;
          final String err=myResource.getResource("titleIsEmpty").getValue();
          handler.sendMessage(handler.obtainMessage(-1,err));
          return;
        }
        if (myUrl.length() == 0) {
          myUrl=null;
          final String err=myResource.getResource("urlIsEmpty").getValue();
          handler.sendMessage(handler.obtainMessage(-1,err));
          return;
        }
        if (mySummary.length() == 0) {
          mySummary=null;
        }
        Uri uri=Uri.parse(myUrl);
        if (uri.getScheme() == null) {
          myUrl="http://" + myUrl;
          uri=Uri.parse(myUrl);
        }
        String siteName=uri.getHost();
        if (siteName == null) {
          final String err=myResource.getResource("invalidUrl").getValue();
          handler.sendMessage(handler.obtainMessage(-1,err));
          return;
        }
        if (siteName.startsWith("www.")) {
          siteName=siteName.substring(4);
        }
        if (myLink == null) {
          final OPDSLinkReader reader=new OPDSLinkReader();
          final HashMap<String,String> links=new HashMap<String,String>();
          links.put(INetworkLink.URL_MAIN,myUrl);
          final ICustomNetworkLink link=reader.createCustomLink(ICustomNetworkLink.INVALID_ID,siteName,myTitle,mySummary,null,links);
          myLink=link;
          if (link != null) {
            if (!NetworkLibrary.Instance().addCustomLink(link)) {
              final String err=myResource.getResource("alreadyExists").getValue();
              handler.sendMessage(handler.obtainMessage(-1,err));
              return;
            }
          }
 else {
            throw new RuntimeException("Unable to create link!!! Impossible!!!");
          }
        }
 else {
          final ICustomNetworkLink link=(ICustomNetworkLink)myLink;
          link.setSiteName(siteName);
          link.setTitle(myTitle);
          link.setSummary(mySummary);
          link.setLink(INetworkLink.URL_MAIN,myUrl);
          link.saveLink();
        }
        handler.sendEmptyMessage(1);
      }
 else {
        handler.sendEmptyMessage(0);
      }
    }
  }
;
  final ZLResource buttonResource=ZLResource.resource("dialog").getResource("button");
  return new AlertDialog.Builder(activity).setView(layout).setTitle(myResource.getResource("title").getValue()).setPositiveButton(buttonResource.getResource("ok").getValue(),listener).setNegativeButton(buttonResource.getResource("cancel").getValue(),listener).setOnCancelListener(new DialogInterface.OnCancelListener(){
    public void onCancel(    DialogInterface dialog){
      listener.onClick(dialog,DialogInterface.BUTTON_NEGATIVE);
    }
  }
).create();
}
