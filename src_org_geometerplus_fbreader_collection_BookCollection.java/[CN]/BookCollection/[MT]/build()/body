{
  System.err.println("before build: " + System.currentTimeMillis() % 20000);
  final HashMap<Tag,TagTree> tagTreeMap=new HashMap<Tag,TagTree>();
  final HashMap<Author,AuthorTree> authorTreeMap=new HashMap<Author,AuthorTree>();
  final HashMap<AuthorSeriesPair,SeriesTree> seriesTreeMap=new HashMap<AuthorSeriesPair,SeriesTree>();
  final List<BookDescription> allDescriptions=collectBookDescriptions();
  System.err.println(allDescriptions.size() + " books " + System.currentTimeMillis() % 20000);
  for (  BookDescription description : allDescriptions) {
    List<Author> authors=description.authors();
    if (authors.isEmpty()) {
      authors=(List<Author>)ourNullList;
    }
    final SeriesInfo seriesInfo=description.getSeriesInfo();
    for (    Author a : authors) {
      AuthorTree authorTree=authorTreeMap.get(a);
      if (authorTree == null) {
        authorTree=myCollectionByAuthor.createAuthorSubTree(a);
        authorTreeMap.put(a,authorTree);
      }
      if (seriesInfo == null) {
        authorTree.createBookSubTree(description);
      }
 else {
        final String series=seriesInfo.Name;
        final AuthorSeriesPair pair=new AuthorSeriesPair(a,series);
        SeriesTree seriesTree=seriesTreeMap.get(pair);
        if (seriesTree == null) {
          seriesTree=authorTree.createSeriesSubTree(series);
          seriesTreeMap.put(pair,seriesTree);
        }
        seriesTree.createBookInSeriesSubTree(description);
      }
    }
    List<Tag> tags=description.tags();
    if (tags.isEmpty()) {
      tags=(List<Tag>)ourNullList;
    }
    for (    Tag t : tags) {
      getTagTree(t,tagTreeMap).createBookSubTree(description);
    }
  }
  BooksDatabase.Instance().executeAsATransaction(new Runnable(){
    public void run(){
      for (      BookDescription description : allDescriptions) {
        description.save();
      }
    }
  }
);
  System.err.println("after build: " + System.currentTimeMillis() % 20000);
}
