{
  ZLTextLineInfo info=new ZLTextLineInfo(start,myStyle.getTextStyle());
  ZLTextWordCursor current=new ZLTextWordCursor(start);
  ZLTextParagraphCursor paragraphCursor=current.getParagraphCursor();
  boolean isFirstLine=current.isStartOfParagraph();
  if (isFirstLine) {
    ZLTextElement element=paragraphCursor.getElement(current.getWordNumber());
    while (element instanceof ZLTextControlElement) {
      if (element instanceof ZLTextControlElement) {
        myStyle.applyControl((ZLTextControlElement)element);
      }
      current.nextWord();
      if (current.equalWordNumber(end)) {
        break;
      }
      element=paragraphCursor.getElement(current.getWordNumber());
    }
    info.StartStyle=myStyle.getTextStyle();
    info.RealStart=new ZLTextWordCursor(current);
  }
  ZLTextStyle storedStyle=myStyle.getTextStyle();
  info.LeftIndent=myStyle.getTextStyle().leftIndent();
  info.Width=info.LeftIndent;
  if (info.RealStart.equalWordNumber(end)) {
    info.End=info.RealStart;
    return info;
  }
  int newWidth=info.Width;
  int newHeight=info.Height;
  int newDescent=info.Descent;
  int maxWidth=myStyle.getPaintContext().getWidth() - myStyle.getTextStyle().rightIndent();
  boolean wordOccurred=false;
  boolean isVisible=false;
  int lastSpaceWidth=0;
  int internalSpaceCounter=0;
  boolean removeLastSpace=false;
  do {
    ZLTextElement element=paragraphCursor.getElement(current.getWordNumber());
    newWidth+=myStyle.elementWidth(element,current.getCharNumber());
    newHeight=Math.max(newHeight,myStyle.elementHeight(element));
    newDescent=Math.max(newDescent,myStyle.elementDescent(element));
    if (element instanceof ZLTextWord) {
      wordOccurred=true;
      isVisible=true;
    }
 else     if (element instanceof ZLTextHSpaceElement) {
      if (wordOccurred) {
        wordOccurred=false;
        internalSpaceCounter++;
        lastSpaceWidth=myStyle.getPaintContext().getSpaceWidth();
        newWidth+=lastSpaceWidth;
      }
    }
 else     if (element instanceof ZLTextControlElement) {
      myStyle.applyControl((ZLTextControlElement)element);
    }
    if ((newWidth > maxWidth) && !info.End.equalWordNumber(start)) {
      break;
    }
    ZLTextElement previousElement=element;
    current.nextWord();
    boolean allowBreak=current.equalWordNumber(end);
    if (!allowBreak) {
      element=paragraphCursor.getElement(current.getWordNumber());
      allowBreak=(((!(element instanceof ZLTextWord)) || (previousElement instanceof ZLTextWord)) && !(element instanceof ZLTextControlElement));
    }
    if (allowBreak) {
      info.IsVisible=isVisible;
      info.Width=newWidth;
      info.Height=Math.max(info.Height,newHeight);
      info.Descent=Math.max(info.Descent,newDescent);
      info.End=current;
      info.SpaceCounter=internalSpaceCounter;
      removeLastSpace=!wordOccurred && (info.SpaceCounter > 0);
    }
  }
 while (!current.equalWordNumber(end));
  if (!current.equalWordNumber(end)) {
    ZLTextElement element=paragraphCursor.getElement(current.getWordNumber());
    if (element instanceof ZLTextWord) {
      newWidth-=myStyle.elementWidth(element,current.getCharNumber());
    }
    info.IsVisible=true;
    info.Width=newWidth;
    info.Height=Math.max(info.Height,newHeight);
    info.Descent=Math.max(info.Descent,newDescent);
    info.End=current;
    info.SpaceCounter=internalSpaceCounter;
  }
  if (removeLastSpace) {
    info.Width-=lastSpaceWidth;
    info.SpaceCounter--;
  }
  myStyle.setStyle(storedStyle);
  if (isFirstLine) {
    info.Height+=info.StartStyle.spaceBefore();
  }
  if (info.End.isEndOfParagraph()) {
    info.VSpaceAfter=myStyle.getTextStyle().spaceAfter();
  }
  return info;
}
