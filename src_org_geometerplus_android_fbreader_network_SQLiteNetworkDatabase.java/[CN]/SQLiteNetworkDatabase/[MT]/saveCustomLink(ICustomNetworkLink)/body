{
  executeAsATransaction(new Runnable(){
    public void run(){
      final SQLiteStatement statement;
      if (link.getId() == ICustomNetworkLink.INVALID_ID) {
        if (myInsertCustomLinkStatement == null) {
          myInsertCustomLinkStatement=myDatabase.compileStatement("INSERT INTO CustomLinks (title,site_name,summary,icon) VALUES (?,?,?,?)");
        }
        statement=myInsertCustomLinkStatement;
      }
 else {
        if (myUpdateCustomLinkStatement == null) {
          myUpdateCustomLinkStatement=myDatabase.compileStatement("UPDATE CustomLinks SET title = ?, site_name = ?, summary =?, icon = ? " + "WHERE link_id = ?");
        }
        statement=myUpdateCustomLinkStatement;
      }
      statement.bindString(1,link.getTitle());
      statement.bindString(2,link.getSiteName());
      bindString(statement,3,link.getSummary());
      bindString(statement,4,link.getIcon());
      final long id;
      final HashMap<String,String> linksMap=new HashMap<String,String>();
      if (statement == myInsertCustomLinkStatement) {
        id=statement.executeInsert();
        link.setId((int)id);
      }
 else {
        id=link.getId();
        statement.bindLong(5,id);
        statement.execute();
        final Cursor linksCursor=myDatabase.rawQuery("SELECT key,url FROM CustomLinkUrls WHERE link_id = " + link.getId(),null);
        while (linksCursor.moveToNext()) {
          linksMap.put(linksCursor.getString(0),linksCursor.getString(1));
        }
        linksCursor.close();
      }
      for (      String key : link.getLinkKeys()) {
        final String value=link.getLink(key);
        final String dbValue=linksMap.remove(key);
        final SQLiteStatement urlStatement;
        if (dbValue == null) {
          if (myInsertCustomLinkUrlStatement == null) {
            myInsertCustomLinkUrlStatement=myDatabase.compileStatement("INSERT INTO CustomLinkUrls(url,link_id,key) VALUES (?,?,?)");
          }
          urlStatement=myInsertCustomLinkUrlStatement;
        }
 else         if (!value.equals(dbValue)) {
          if (myUpdateCustomLinkUrlStatement == null) {
            myUpdateCustomLinkUrlStatement=myDatabase.compileStatement("UPDATE CustomLinkUrls SET url = ? WHERE link_id = ? AND key = ?");
          }
          urlStatement=myUpdateCustomLinkUrlStatement;
        }
 else {
          continue;
        }
        urlStatement.bindString(1,value);
        urlStatement.bindLong(2,id);
        urlStatement.bindString(3,key);
        urlStatement.execute();
      }
      for (      String key : linksMap.keySet()) {
        if (myDeleteCustomLinkUrlStatement == null) {
          myDeleteCustomLinkUrlStatement=myDatabase.compileStatement("DELETE FROM CustomLinkUrls WHERE link_id = ? AND key = ?");
        }
        myDeleteCustomLinkUrlStatement.bindLong(1,id);
        myDeleteCustomLinkUrlStatement.bindString(2,key);
        myDeleteCustomLinkUrlStatement.execute();
      }
    }
  }
);
}
