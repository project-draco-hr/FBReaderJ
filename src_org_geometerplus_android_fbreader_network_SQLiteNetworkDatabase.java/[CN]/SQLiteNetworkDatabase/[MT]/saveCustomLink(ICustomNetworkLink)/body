{
  executeAsATransaction(new Runnable(){
    public void run(){
      final SQLiteStatement statement;
      if (link.getId() == ICustomNetworkLink.INVALID_ID) {
        if (myInsertCustomLinkStatement == null) {
          myInsertCustomLinkStatement=myDatabase.compileStatement("INSERT INTO CustomLinks (title,site_name,summary,icon) VALUES (?,?,?,?)");
        }
        statement=myInsertCustomLinkStatement;
      }
 else {
        if (myUpdateCustomLinkStatement == null) {
          myUpdateCustomLinkStatement=myDatabase.compileStatement("UPDATE CustomLinks SET title = ?, site_name = ?, summary =?, icon = ? " + "WHERE link_id = ?");
        }
        statement=myUpdateCustomLinkStatement;
      }
      statement.bindString(1,link.getTitle());
      statement.bindString(2,link.getSiteName());
      SQLiteUtil.bindString(statement,3,link.getSummary());
      SQLiteUtil.bindString(statement,4,link.getIcon());
      final long id;
      final HashMap<String,URLInfo> linksMap=new HashMap<String,URLInfo>();
      if (statement == myInsertCustomLinkStatement) {
        id=statement.executeInsert();
        link.setId((int)id);
      }
 else {
        id=link.getId();
        statement.bindLong(5,id);
        statement.execute();
        final Cursor linksCursor=myDatabase.rawQuery("SELECT key,url,update_time FROM LinkUrls WHERE url NOT NULL AND link_id = " + link.getId(),null);
        while (linksCursor.moveToNext()) {
          linksMap.put(linksCursor.getString(0),new URLInfo(linksCursor.getString(1),SQLiteUtil.getDate(linksCursor,2)));
        }
        linksCursor.close();
      }
      for (      String key : link.getUrlKeys()) {
        final URLInfo info=link.getUrlInfo(key);
        final URLInfo dbInfo=linksMap.remove(key);
        final SQLiteStatement urlStatement;
        if (dbInfo == null) {
          if (myInsertCustomLinkUrlStatement == null) {
            myInsertCustomLinkUrlStatement=myDatabase.compileStatement("INSERT OR REPLACE INTO LinkUrls(url,update_time,link_id,key) VALUES (?,?,?,?)");
          }
          urlStatement=myInsertCustomLinkUrlStatement;
        }
 else         if (!info.equals(dbInfo)) {
          if (myUpdateCustomLinkUrlStatement == null) {
            myUpdateCustomLinkUrlStatement=myDatabase.compileStatement("UPDATE LinkUrls SET url = ?, update_time = ? WHERE link_id = ? AND key = ?");
          }
          urlStatement=myUpdateCustomLinkUrlStatement;
        }
 else {
          continue;
        }
        SQLiteUtil.bindString(urlStatement,1,info.URL);
        SQLiteUtil.bindDate(urlStatement,2,info.Updated);
        urlStatement.bindLong(3,id);
        urlStatement.bindString(4,key);
        urlStatement.execute();
      }
      for (      String key : linksMap.keySet()) {
        if (myDeleteCustomLinkUrlStatement == null) {
          myDeleteCustomLinkUrlStatement=myDatabase.compileStatement("DELETE FROM LinkUrls WHERE link_id = ? AND key = ?");
        }
        myDeleteCustomLinkUrlStatement.bindLong(1,id);
        myDeleteCustomLinkUrlStatement.bindString(2,key);
        myDeleteCustomLinkUrlStatement.execute();
      }
    }
  }
);
}
