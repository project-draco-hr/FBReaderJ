{
  executeAsATransaction(new Runnable(){
    public void run(){
      final SQLiteStatement statement;
      if (link.getId() == INetworkLink.INVALID_ID) {
        if (myInsertCustomLinkStatement == null) {
          myInsertCustomLinkStatement=myDatabase.compileStatement("INSERT INTO Links (title,site_name,summary,is_predefined,is_enabled) VALUES (?,?,?,?,?)");
        }
        statement=myInsertCustomLinkStatement;
      }
 else {
        if (myUpdateCustomLinkStatement == null) {
          myUpdateCustomLinkStatement=myDatabase.compileStatement("UPDATE Links SET title = ?, site_name = ?, summary =? " + "WHERE link_id = ?");
        }
        statement=myUpdateCustomLinkStatement;
      }
      statement.bindString(1,link.getTitle());
      statement.bindString(2,link.getSiteName());
      SQLiteUtil.bindString(statement,3,link.getSummary());
      final long id;
      final UrlInfoCollection<UrlInfoWithDate> linksMap=new UrlInfoCollection<UrlInfoWithDate>();
      if (statement == myInsertCustomLinkStatement) {
        statement.bindLong(4,0);
        statement.bindLong(5,1);
        id=statement.executeInsert();
        link.setId((int)id);
      }
 else {
        id=link.getId();
        statement.bindLong(4,id);
        statement.execute();
        final Cursor linksCursor=myDatabase.rawQuery("SELECT key,url,update_time FROM LinkUrls WHERE link_id = " + link.getId(),null);
        while (linksCursor.moveToNext()) {
          try {
            linksMap.addInfo(new UrlInfoWithDate(UrlInfo.Type.valueOf(linksCursor.getString(0)),linksCursor.getString(1),SQLiteUtil.getDate(linksCursor,2)));
          }
 catch (          IllegalArgumentException e) {
          }
        }
        linksCursor.close();
      }
      for (      UrlInfo.Type key : link.getUrlKeys()) {
        final UrlInfoWithDate info=link.getUrlInfo(key);
        final UrlInfoWithDate dbInfo=linksMap.getInfo(key);
        linksMap.removeAllInfos(key);
        final SQLiteStatement urlStatement;
        if (dbInfo == null) {
          if (myInsertCustomLinkUrlStatement == null) {
            myInsertCustomLinkUrlStatement=myDatabase.compileStatement("INSERT OR REPLACE INTO LinkUrls(url,update_time,link_id,key) VALUES (?,?,?,?)");
          }
          urlStatement=myInsertCustomLinkUrlStatement;
        }
 else         if (!info.equals(dbInfo)) {
          if (myUpdateCustomLinkUrlStatement == null) {
            myUpdateCustomLinkUrlStatement=myDatabase.compileStatement("UPDATE LinkUrls SET url = ?, update_time = ? WHERE link_id = ? AND key = ?");
          }
          urlStatement=myUpdateCustomLinkUrlStatement;
        }
 else {
          continue;
        }
        SQLiteUtil.bindString(urlStatement,1,info.Url);
        SQLiteUtil.bindDate(urlStatement,2,info.Updated);
        urlStatement.bindLong(3,id);
        urlStatement.bindString(4,key.toString());
        urlStatement.execute();
      }
      for (      UrlInfo info : linksMap.getAllInfos()) {
        if (myDeleteCustomLinkUrlStatement == null) {
          myDeleteCustomLinkUrlStatement=myDatabase.compileStatement("DELETE FROM LinkUrls WHERE link_id = ? AND key = ?");
        }
        myDeleteCustomLinkUrlStatement.bindLong(1,id);
        myDeleteCustomLinkUrlStatement.bindString(2,info.InfoType.toString());
        myDeleteCustomLinkUrlStatement.execute();
      }
    }
  }
);
}
